<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Productivity Tracker</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
  <nav class="navbar">
    <h2>Productivity Tracker</h2>
    <div class="nav-links">
      <a href="/dashboard">Dashboard</a>
      <a href="/calendar">Calendar</a>
      <a href="/analytics">Analytics</a>
      <a href="/settings" class="active">Settings</a>
      <a href="/logout">Logout</a>
    </div>
  </nav>

  <div class="container">
    <h1 style="text-align: center;">Settings</h1>
    
    <div class="user-info form-box-new">
        <h2>Account Information</h2>
        <br>
        <p><strong>Name:</strong> <%= user.name %></p>
        <p><strong>Email:</strong> <%= user.email %></p>
        <p><strong>Member Since:</strong> <%= user.createdAt.toLocaleDateString() %></p>
      </div>
    
    <div class="form-box-new">
      <h2>Update Daily Goal</h2>
      <br>
      <% if (success && success.includes('Goal')) { %>
        <div class="success"><%= success %></div>
      <% } %>
      <% if (error && error.includes('goal')) { %>
        <div class="error"><%= error %></div>
      <% } %>
      
      <form action="/update-goal" method="POST">
        <div class="form-group">
          <label for="dailyGoalHours">Daily Goal (Hours)</label>
          <input 
            type="number" 
            id="dailyGoalHours" 
            name="dailyGoalHours" 
            value="<%= user.dailyGoalHours %>" 
            step="0.5" 
            min="0.5" 
            max="24" 
            required>
        </div>
        <button type="submit" class="btn">Update Goal</button>
      </form>
    </div>

    <div class="form-box-new">
      <h2>Update Password</h2>
      <br>
      <% if (success && success.includes('Password')) { %>
        <div class="success"><%= success %></div>
      <% } %>
      <% if (error && (error.includes('password') || error.includes('passwords'))) { %>
        <div class="error"><%= error %></div>
      <% } %>
      <form action="/update-password" method="POST">
        <div class="form-group">
          <label for="currentPassword">Current Password</label>
          <input type="password" id="currentPassword" name="currentPassword" minlength="6" required>
        </div>
        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" name="newPassword" minlength="6" required>
        </div>
        <div class="form-group">
          <label for="confirmNewPassword">Confirm New Password</label>
          <input type="password" id="confirmNewPassword" name="confirmNewPassword" minlength="6" required disabled>
          <div id="password-match-message-update" class="password-match-message" style="display: none;">Passwords do not match</div>
        </div>
        <button type="submit" class="btn">Update Password</button>
      </form>
    </div>

    <div class="form-box-new">
      <h2>Clear Account Data</h2>
      <br>
      <% if (success && success.includes('cleared')) { %>
        <div class="success"><%= success %></div>
      <% } %>
      <% if (error && error.includes('clearing')) { %>
        <div class="error"><%= error %></div>
      <% } %>
      <p>This will permanently delete all of your study logs. Your account will not be deleted. Please be certain.</p>
      <br>
      <form action="/clear-account-data" method="POST" onsubmit="return confirm('Are you sure you want to clear all your study data? This action cannot be undone.');">
        <button type="submit" class="btn" style="background-color: #FF5722;">Clear All Data</button>
      </form>
    </div>
  </div>

  <script>
    const newPasswordInput = document.getElementById('newPassword');
    const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
    const passwordMatchMessageUpdate = document.getElementById('password-match-message-update');

    newPasswordInput.addEventListener('input', () => {
      if (newPasswordInput.value.length > 0) {
        confirmNewPasswordInput.disabled = false;
      } else {
        confirmNewPasswordInput.disabled = true;
      }
      validateNewPasswords();
    });

    confirmNewPasswordInput.addEventListener('input', validateNewPasswords);

    function validateNewPasswords() {
      if (confirmNewPasswordInput.value.length > 0 && newPasswordInput.value !== confirmNewPasswordInput.value) {
        passwordMatchMessageUpdate.style.display = 'block';
        newPasswordInput.classList.add('password-mismatch');
        confirmNewPasswordInput.classList.add('password-mismatch');
        newPasswordInput.classList.remove('password-match');
        confirmNewPasswordInput.classList.remove('password-match');
      } else if (confirmNewPasswordInput.value.length > 0 && newPasswordInput.value === confirmNewPasswordInput.value) {
        passwordMatchMessageUpdate.style.display = 'none';
        newPasswordInput.classList.remove('password-mismatch');
        confirmNewPasswordInput.classList.remove('password-mismatch');
        newPasswordInput.classList.add('password-match');
        confirmNewPasswordInput.classList.add('password-match');
      } else {
        passwordMatchMessageUpdate.style.display = 'none';
        newPasswordInput.classList.remove('password-mismatch', 'password-match');
        confirmNewPasswordInput.classList.remove('password-mismatch', 'password-match');
      }
    }
  </script>
</body>
</html>